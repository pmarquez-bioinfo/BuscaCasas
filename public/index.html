<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè† BuscaCasas - Uruguay Real Estate</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .property-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .property-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API functions
        const api = {
            async getProperties(filters = {}) {
                const params = new URLSearchParams();
                Object.entries(filters).forEach(([key, value]) => {
                    if (value !== undefined && value !== '') {
                        params.set(key, value);
                    }
                });

                const response = await fetch(`/api/properties?${params}`);
                return response.json();
            },

            async getStats() {
                const response = await fetch('/api/stats');
                return response.json();
            },

            async scrapeProperties(source = 'both', pages = 2, filters = {}) {
                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ source, pages, filters })
                });
                return response.json();
            }
        };

        // Utility functions
        const formatPrice = (price, currency) => {
            const formatted = new Intl.NumberFormat('es-UY').format(price);
            return `${currency} ${formatted}`;
        };

        const formatDate = (dateString) => {
            return new Date(dateString).toLocaleDateString('es-UY');
        };

        // Components
        const Header = ({ onScrape, isLoading, filters }) => (
            <header className="bg-white shadow-sm border-b">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h1 className="text-3xl font-bold text-gray-900">
                                üè† BuscaCasas
                            </h1>
                            <p className="text-gray-600 mt-1">Uruguay Real Estate Aggregator</p>
                        </div>
                        <div className="flex flex-col items-end space-y-2">
                            {Object.keys(filters).length > 0 && Object.values(filters).some(v => v) && (
                                <div className="text-sm text-gray-600">
                                    Will scrape with current filters
                                </div>
                            )}
                            <button
                                onClick={() => onScrape(filters)}
                                disabled={isLoading}
                                className={`px-6 py-3 rounded-lg font-medium transition-colors ${
                                    isLoading
                                        ? 'bg-gray-400 cursor-not-allowed text-gray-200'
                                        : 'bg-blue-600 hover:bg-blue-700 text-white'
                                } flex items-center space-x-2`}
                            >
                                {isLoading ? (
                                    <>
                                        <div className="loading-spinner"></div>
                                        <span>Scraping...</span>
                                    </>
                                ) : (
                                    <>
                                        <i className="fas fa-sync-alt"></i>
                                        <span>Scrape Properties</span>
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            </header>
        );

        const Filters = ({ filters, onFilterChange, stats }) => (
            <div className="bg-white shadow-sm rounded-lg p-6 mb-6">
                <h3 className="text-lg font-semibold text-gray-900 mb-4">Filters</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Operation</label>
                        <select
                            value={filters.operation || ''}
                            onChange={(e) => onFilterChange('operation', e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">All Operations</option>
                            <option value="venta">For Sale</option>
                            <option value="alquiler">For Rent</option>
                        </select>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Department</label>
                        <select
                            value={filters.department || ''}
                            onChange={(e) => onFilterChange('department', e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">All Departments</option>
                            {stats?.byDepartment?.map(dept => (
                                <option key={dept.department} value={dept.department}>
                                    {dept.department} ({dept.count})
                                </option>
                            ))}
                        </select>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Property Type</label>
                        <select
                            value={filters.propertyType || ''}
                            onChange={(e) => onFilterChange('propertyType', e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">All Types</option>
                            <option value="casa">Casa</option>
                            <option value="apartamento">Apartamento</option>
                            <option value="ph">PH</option>
                            <option value="terreno">Terreno</option>
                        </select>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Min Price</label>
                        <input
                            type="number"
                            value={filters.minPrice || ''}
                            onChange={(e) => onFilterChange('minPrice', e.target.value)}
                            placeholder="Min price"
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Max Price</label>
                        <input
                            type="number"
                            value={filters.maxPrice || ''}
                            onChange={(e) => onFilterChange('maxPrice', e.target.value)}
                            placeholder="Max price"
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                        <select
                            value={filters.currency || ''}
                            onChange={(e) => onFilterChange('currency', e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">All Currencies</option>
                            <option value="UYU">UYU (Pesos)</option>
                            <option value="USD">USD (Dollars)</option>
                        </select>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Min Bedrooms</label>
                        <select
                            value={filters.minBedrooms || ''}
                            onChange={(e) => onFilterChange('minBedrooms', e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">Any</option>
                            <option value="1">1+ bedroom</option>
                            <option value="2">2+ bedrooms</option>
                            <option value="3">3+ bedrooms</option>
                            <option value="4">4+ bedrooms</option>
                            <option value="5">5+ bedrooms</option>
                        </select>
                    </div>
                </div>
            </div>
        );

        const PropertyCard = ({ property }) => (
            <div className="property-card bg-white rounded-lg shadow-sm border overflow-hidden">
                {property.thumbnailUrl && (
                    <div className="relative h-48 bg-gray-200">
                        <img
                            src={property.thumbnailUrl}
                            alt={property.title}
                            className="w-full h-full object-cover"
                            onError={(e) => {
                                e.target.style.display = 'none';
                            }}
                        />
                        <div className="absolute top-2 left-2">
                            <span className={`px-2 py-1 text-xs font-medium rounded ${
                                property.source === 'mercadolibre'
                                    ? 'bg-yellow-100 text-yellow-800'
                                    : 'bg-blue-100 text-blue-800'
                            }`}>
                                {property.source === 'mercadolibre' ? 'MercadoLibre' : 'InfoCasas'}
                            </span>
                        </div>
                    </div>
                )}

                <div className="p-4">
                    <h3 className="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">
                        {property.title}
                    </h3>

                    <div className="text-2xl font-bold text-blue-600 mb-3">
                        {formatPrice(property.price, property.currency)}
                    </div>

                    <div className="space-y-2 text-sm text-gray-600">
                        <div className="flex items-center">
                            <i className="fas fa-map-marker-alt w-4"></i>
                            <span className="ml-2">
                                {property.neighborhood ? `${property.neighborhood}, ` : ''}{property.department}
                            </span>
                        </div>

                        {(property.bedrooms || property.bathrooms || property.totalArea) && (
                            <div className="flex items-center space-x-4">
                                {property.bedrooms && (
                                    <div className="flex items-center">
                                        <i className="fas fa-bed w-4"></i>
                                        <span className="ml-1">{property.bedrooms} bed</span>
                                    </div>
                                )}
                                {property.bathrooms && (
                                    <div className="flex items-center">
                                        <i className="fas fa-bath w-4"></i>
                                        <span className="ml-1">{property.bathrooms} bath</span>
                                    </div>
                                )}
                                {property.totalArea && (
                                    <div className="flex items-center">
                                        <i className="fas fa-ruler w-4"></i>
                                        <span className="ml-1">{property.totalArea} m¬≤</span>
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="flex items-center">
                            <i className="fas fa-clock w-4"></i>
                            <span className="ml-2">Scraped {formatDate(property.scrapedAt)}</span>
                        </div>
                    </div>

                    {(property.hasParrillero || property.hasPortero || property.hasPool) && (
                        <div className="mt-3 flex flex-wrap gap-2">
                            {property.hasParrillero && (
                                <span className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">
                                    Parrillero
                                </span>
                            )}
                            {property.hasPortero && (
                                <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">
                                    Portero
                                </span>
                            )}
                            {property.hasPool && (
                                <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">
                                    Pool
                                </span>
                            )}
                        </div>
                    )}

                    <div className="mt-4">
                        <a
                            href={property.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="w-full inline-flex justify-center items-center px-4 py-2 border border-blue-600 text-blue-600 font-medium rounded-md hover:bg-blue-50 transition-colors"
                        >
                            <span>View Property</span>
                            <i className="fas fa-external-link-alt ml-2"></i>
                        </a>
                    </div>
                </div>
            </div>
        );

        const Stats = ({ stats }) => (
            <div className="bg-white rounded-lg shadow-sm border p-6 mb-6">
                <h3 className="text-lg font-semibold text-gray-900 mb-4">Statistics</h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div className="text-center">
                        <div className="text-3xl font-bold text-blue-600">{stats?.total || 0}</div>
                        <div className="text-gray-600">Total Properties</div>
                    </div>
                    <div>
                        <h4 className="font-medium text-gray-900 mb-2">By Source</h4>
                        {stats?.bySource?.map(source => (
                            <div key={source.source} className="flex justify-between text-sm">
                                <span className="capitalize">{source.source}</span>
                                <span>{source.count}</span>
                            </div>
                        ))}
                    </div>
                    <div>
                        <h4 className="font-medium text-gray-900 mb-2">By Department</h4>
                        {stats?.byDepartment?.slice(0, 3).map(dept => (
                            <div key={dept.department} className="flex justify-between text-sm">
                                <span>{dept.department}</span>
                                <span>{dept.count}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        // Main App Component
        const App = () => {
            const [properties, setProperties] = useState([]);
            const [stats, setStats] = useState(null);
            const [filters, setFilters] = useState({});
            const [loading, setLoading] = useState(false);
            const [scraping, setScraping] = useState(false);

            useEffect(() => {
                loadProperties();
                loadStats();
            }, [filters]);

            const loadProperties = async () => {
                setLoading(true);
                try {
                    const data = await api.getProperties(filters);
                    setProperties(data.properties || []);
                } catch (error) {
                    console.error('Error loading properties:', error);
                } finally {
                    setLoading(false);
                }
            };

            const loadStats = async () => {
                try {
                    const statsData = await api.getStats();
                    setStats(statsData);
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            };

            const handleFilterChange = (key, value) => {
                setFilters(prev => ({
                    ...prev,
                    [key]: value
                }));
            };

            const handleScrape = async (currentFilters = {}) => {
                setScraping(true);
                try {
                    // Clean filters to only include non-empty values
                    const cleanFilters = Object.entries(currentFilters)
                        .filter(([key, value]) => value !== undefined && value !== '')
                        .reduce((acc, [key, value]) => ({ ...acc, [key]: value }), {});

                    const result = await api.scrapeProperties('both', 2, cleanFilters);

                    const filterText = Object.keys(cleanFilters).length > 0
                        ? ` with filters: ${Object.entries(cleanFilters).map(([k,v]) => `${k}=${v}`).join(', ')}`
                        : '';

                    alert(`Scraping completed${filterText}! Found ${result.totalFound} properties, saved ${result.totalSaved}.`);
                    loadProperties();
                    loadStats();
                } catch (error) {
                    alert(`Scraping failed: ${error.message}`);
                } finally {
                    setScraping(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    <Header onScrape={handleScrape} isLoading={scraping} filters={filters} />

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <Stats stats={stats} />
                        <Filters
                            filters={filters}
                            onFilterChange={handleFilterChange}
                            stats={stats}
                        />

                        {loading ? (
                            <div className="flex justify-center items-center py-12">
                                <div className="loading-spinner mr-3"></div>
                                <span>Loading properties...</span>
                            </div>
                        ) : (
                            <>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-semibold text-gray-900">
                                        Properties ({properties.length})
                                    </h2>
                                </div>

                                {properties.length === 0 ? (
                                    <div className="text-center py-12">
                                        <i className="fas fa-home text-6xl text-gray-300 mb-4"></i>
                                        <h3 className="text-lg font-medium text-gray-900 mb-2">No properties found</h3>
                                        <p className="text-gray-600 mb-4">Try adjusting your filters or scrape new properties.</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                        {properties.map(property => (
                                            <PropertyCard key={property.id} property={property} />
                                        ))}
                                    </div>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>